name: Backend - Build, Push, and Deploy

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'backend/**'
      - '.github/workflows/backend-deploy.yml'

env:
  ACR_NAME: resumeacr70346
  IMAGE_NAME: resume-backend
  RESOURCE_GROUP: resume-app-rg
  CONTAINER_NAME: resume-backend

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Log in to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Log in to Azure Container Registry
      run: |
        az acr login --name ${{ env.ACR_NAME }}

    - name: Build Docker image
      run: |
        docker build \
          -f backend/Dockerfile \
          -t ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest \
          -t ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }} \
          ./backend

    - name: Push Docker image
      run: |
        docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest
        docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}

    - name: Deploy to Azure Container Instance
      run: |
        # Get ACR credentials
        ACR_USERNAME=$(az acr credential show --name ${{ env.ACR_NAME }} --query username -o tsv)
        ACR_PASSWORD=$(az acr credential show --name ${{ env.ACR_NAME }} --query "passwords[0].value" -o tsv)
        
        # Delete existing container
        az container delete \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --name ${{ env.CONTAINER_NAME }} \
          --yes || true
        
        # Wait for deletion
        sleep 15
        
        # Create new container
        az container create \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --name ${{ env.CONTAINER_NAME }} \
          --image ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest \
          --registry-login-server ${{ env.ACR_NAME }}.azurecr.io \
          --registry-username $ACR_USERNAME \
          --registry-password $ACR_PASSWORD \
          --cpu 1 \
          --memory 2 \
          --ports 8080 \
          --dns-name-label ${{ env.CONTAINER_NAME }} \
          --os-type Linux \
          --environment-variables \
            NODE_ENV=production \
            FRONTEND_URL=${{ secrets.FRONTEND_URL }} \
            DATABASE_URL=${{ secrets.DATABASE_URL }} \
            CLERK_PUBLISHABLE_KEY=${{ secrets.CLERK_PUBLISHABLE_KEY }} \
            CLERK_SECRET_KEY=${{ secrets.CLERK_SECRET_KEY }} \
            NEBIUS_API_KEY=${{ secrets.NEBIUS_API_KEY }} \
            CLOUDINARY_URL=${{ secrets.CLOUDINARY_URL }} \
            CLOUDINARY_CLOUD_NAME=${{ secrets.CLOUDINARY_CLOUD_NAME }} \
            CLOUDINARY_API_KEY=${{ secrets.CLOUDINARY_API_KEY }} \
            CLOUDINARY_API_SECRET=${{ secrets.CLOUDINARY_API_SECRET }}

    - name: Verify deployment
      run: |
        echo "Waiting for container to start..."
        sleep 30
        
        CONTAINER_STATE=$(az container show \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --name ${{ env.CONTAINER_NAME }} \
          --query "instanceView.state" -o tsv)
        
        echo "Container state: $CONTAINER_STATE"
        
        if [ "$CONTAINER_STATE" == "Running" ]; then
          echo "✅ Deployment successful!"
          echo "Backend URL: http://${{ env.CONTAINER_NAME }}.eastus.azurecontainer.io:8080"
        else
          echo "❌ Deployment failed - container not running"
          exit 1
        fi
